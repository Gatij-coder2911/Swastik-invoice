<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Invoices</title>

    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='images/site.webmanifest') }}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">


</head>

<body>

    <div class="container mt-4">
        <a href="/logout" 
            onclick="return confirm('Are you sure you want to log out?');"
            class="btn btn-white text-danger border-0 shadow-sm position-fixed top-0 end-0 m-3 m-md-4 rounded-pill fw-bold d-flex align-items-center justify-content-center" 
            style="z-index: 1050; background-color: rgba(255,255,255,0.9); backdrop-filter: blur(5px); height: 45px; min-width: 45px;">
                
                <i class="fa-solid fa-power-off"></i>
                
                <span class="ms-2 d-none d-md-inline">Logout</span>
        </a>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-modern {{ category }}">
            {{ message }}
            <button type="button" class="btn-close-custom" onclick="this.parentElement.style.display='none'">×</button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
        <a href="/"
            class="btn btn-outline-primary rounded-pill px-3 shadow-sm me-3 d-inline-flex align-items-center">
            <i class="fa-solid fa-arrow-left"></i>

            <span class="ms-2 d-none d-sm-inline">Back</span>
        </a>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>

                <h2 class="fw-bold text-dark mb-0">Invoices</h2>
                <p class="text-muted small mb-0">Manage your billing details</p>
            </div>

            <div class="d-flex gap-3">
                <div class="search-wrapper">
                    <i class="fa fa-search search-icon"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search invoices...">
                </div>
                <a href="/" class="btn btn-primary rounded-pill px-4 d-flex align-items-center">
                    <i class="fa fa-plus me-2"></i> New
                </a>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="table-responsive">
                <table class="table table-modern" id="invoiceTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Invoice No <span class="sort-icon"></span></th>
                            <th onclick="sortTable(1)">Date <span class="sort-icon"></span></th>
                            <th onclick="sortTable(2)">Customer <span class="sort-icon"></span></th>
                            <th onclick="sortTable(3)">Amount <span class="sort-icon"></span></th>
                            <th onclick="sortTable(4)">Balance <span class="sort-icon"></span></th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in invoices %}
                        <tr>
                            <td>{{ row.id }}</td>
                            <td data-date="{{ row.date }}">{{ row.date.strftime('%d-%b-%Y') if row.date else '' }}</td>
                            <td>{{ row.customer }}</td>
                            <td>₹{{ row.inv_amt }}</td>
                            <td class="fw-bold">₹{{ row.balance }}</td>

                            <td>
                                {% if row.balance == 0 %}
                                <span class="badge badge-soft-success">Paid</span>
                                {% elif row.balance == row.inv_amt %}
                                <span class="badge badge-soft-danger">Unpaid</span>
                                {% else %}
                                <span class="badge badge-soft-warning">Partial</span>
                                {% endif %}
                            </td>

                            <td class="text-end">
                                <a href="/edit-invoice/{{ row.id | replace('/', '_') }}"
                                    class="btn btn-sm btn-outline-primary rounded-circle" title="Edit">
                                    <i class="fa fa-pencil"></i>
                                </a>

                                <form action="/delete-invoice/{{ row.id | replace('/', '_') }}" method="POST"
                                    class="d-inline" onsubmit="return confirm('Delete this invoice?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger rounded-circle"
                                        title="Delete">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div id="noResults" class="text-center py-5" style="display: none;">
                <p class="text-muted">No invoices found matching your search.</p>
            </div>
        </div>
    </div>

    <script>
        // --- SEARCH FUNCTION (unchanged, but included for completeness) ---
        document.getElementById('searchInput').addEventListener('keyup', function () {
            let filter = this.value.toLowerCase();
            let rows = document.querySelectorAll('#invoiceTable tbody tr');
            let hasVisibleRow = false;

            rows.forEach(row => {
                let text = row.innerText.toLowerCase();
                if (text.includes(filter)) {
                    row.style.display = '';
                    hasVisibleRow = true;
                } else {
                    row.style.display = 'none';
                }
            });

            document.getElementById('noResults').style.display = hasVisibleRow ? 'none' : 'block';
        });

        // --- NEW FAST SORT FUNCTION ---
        // Tracks the current direction for each column
        const sortDirections = {};

        function sortTable(columnIndex) {
            const table = document.getElementById("invoiceTable");
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr")); // Convert to Array

            // 1. Determine Direction (Toggle)
            // If currently 'asc', switch to 'desc', otherwise 'asc'
            const currentDir = sortDirections[columnIndex] || 'asc';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            sortDirections[columnIndex] = newDir;

            // 2. Update Icons (Visuals)
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'sort-icon'; // Reset all
            });
            const headerTh = table.querySelectorAll('thead th')[columnIndex];
            const activeIcon = headerTh.querySelector('.sort-icon');
            if (activeIcon) activeIcon.classList.add(newDir); // Add 'asc' or 'desc' class

            // 3. Sort the Rows in Memory
            rows.sort((rowA, rowB) => {
                const cellA = rowA.children[columnIndex];
                const cellB = rowB.children[columnIndex];

                // Get values (Check for data-date first, then text)
                let valA = cellA.getAttribute('data-date') || cellA.innerText.trim();
                let valB = cellB.getAttribute('data-date') || cellB.innerText.trim();

                // Date detection (ISO or ISO+time)
                const isoRe = /^\d{4}-\d{2}-\d{2}(T|\s|$)/;
                if (isoRe.test(valA) && isoRe.test(valB)) {
                  const timeA = Date.parse(valA);
                  const timeB = Date.parse(valB);
                  return newDir === 'asc' ? timeA - timeB : timeB - timeA;
                }

                // Clean up Currency (Remove '₹' and commas)
                const numA = parseFloat(valA.replace(/[₹,]/g, ''));
                const numB = parseFloat(valB.replace(/[₹,]/g, ''));

                // Check if both are numbers (and not empty strings or NaN)
                const isNumeric = !isNaN(numA) && !isNaN(numB) && valA !== '' && valB !== '';

                if (isNumeric) {
                    // Numeric Sort
                    return newDir === 'asc' ? numA - numB : numB - numA;
                } else {
                    // String Sort (Case insensitive)
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                    if (valA < valB) return newDir === 'asc' ? -1 : 1;
                    if (valA > valB) return newDir === 'asc' ? 1 : -1;
                    return 0;
                }
            });

            // 4. Put sorted rows back into the table
            rows.forEach(row => tbody.appendChild(row));
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>